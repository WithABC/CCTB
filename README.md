# CCTB
# 自定义命令工具箱

**CCTB** (Custom Command Toolbox) 是一个轻量级自定义命令行工具箱，支持本地存储与 GitHub 云同步，具备高危命令防护、智能缓存、跨平台兼容等特性，适配单机与多设备协作场景。


## 🌟 核心特性
| 特性                | 说明                                                                 |
|---------------------|----------------------------------------------------------------------|
| **快速执行**        | 输入数字直接运行命令，支持关键词模糊搜索（名称/内容，不区分大小写）  |
| **双模式同步**      | 本地模式（纯本地存储）、GitHub模式（私有仓库同步，Base58编码存储Token） |
| **智能缓存**        | 自动缓存最近N条命令（默认10条，可通过配置文件自定义缓存大小）        |
| **高危命令防护**    | 检测 `rm -rf /`、`dd`、`shutdown` 等危险操作，强制二次确认            |
| **跨平台兼容**      | 适配 Linux（Ubuntu/CentOS/Alpine）、macOS，自动处理系统差异（如日期命令） |
| **便捷管理**        | 支持命令添加/编辑/删除/排序，导入导出（JSON格式，支持合并/替换模式）  |
| **调试模式**        | 开启 `DEBUG=1 cb` 可查看缓存命中、同步日志、命令解析过程              |


## 🚀 快速入门
### 1. 安装脚本
#### 推荐：一键安装（自动处理依赖与权限）
```bash
bash <(curl -fsSL https://raw.githubusercontent.com/withabc/cctb/main/cctb.sh)
```

#### 进阶：传参同步安装（新设备快速配置GitHub模式）
```bash
# 格式：一键安装 + 同步到指定GitHub仓库
bash <(curl -fsSL https://raw.githubusercontent.com/withabc/cctb/main/cctb.sh) --sync "用户名/仓库名" "YOUR_GITHUB_TOKEN"
```

#### 手动安装（适合离线环境）
```bash
# 1. 下载脚本
wget https://raw.githubusercontent.com/withabc/cctb/main/cctb.sh -O cctb.sh
# 2. 添加执行权限
chmod +x cctb.sh
# 3. 安装到系统路径（需sudo权限）
sudo cp cctb.sh /usr/local/bin/cb
sudo chmod +x /usr/local/bin/cb
```

### 2. 基础用法
#### 启动工具（默认命令：`cb`）
```bash
cb
```

#### 命令行选项
```bash
cb [选项]
选项说明：
  cb                    启动一级主界面（仅显示可执行命令，屏蔽管理操作）
  cb -h/--help          查看完整帮助文档
  cb -v/--version       查看当前版本及核心特性
  cb -m/--manage        直接进入二级设置界面（命令管理/同步/配置）
  cb -s/--sync          手动触发GitHub同步（仅GitHub模式有效，自动处理冲突）
  cb --reset            重置配置（清除 ~/.cctb 下所有数据，重新选择模式）
  cb --change-cmd       修改启动命令（如从cb改为cctb，自动重启生效）
  DEBUG=1 cb            开启调试模式（显示缓存日志、同步过程）
```


## 🔧 功能详解
### 1. 命令类型（4种类型适配不同场景）
| 类型                | 适用场景                                  | 配置示例                                  |
|---------------------|-------------------------------------------|-------------------------------------------|
| **本地命令**        | 单机常用命令（如系统监控、进程查看）      | 命令内容：`htop`、`docker ps -a`          |
| **私仓命令**        | GitHub模式专属，使用已配置仓库/分支       | 自动加载仓库配置，仅需输入脚本名（如 `cctb.sh`） |
| **公仓命令**        | 调用GitHub公共仓库脚本                    | 路径格式：`user/repo/branch/script.sh`（如 `withabc/cctb/main/test.sh`） |
| **网络命令**        | 调用远程网络脚本                          | 网址格式：`test.com/test.sh`（自动补全http/https） |

### 2. 界面操作规则
#### 一级主界面（执行命令）
- 输入 **命令编号**：直接执行对应命令
- 输入 **关键词**：模糊搜索命令（如输入 `docker` 匹配所有含docker的命令）
- 输入 **99**：进入二级设置界面
- 输入 **00**：退出程序

#### 二级设置界面（命令管理）
| 操作编号 | 功能                | 说明                                                                 |
|----------|---------------------|----------------------------------------------------------------------|
| 01       | 添加命令            | 选择命令类型，自动校验高危命令，GitHub模式下添加后自动同步            |
| 02       | 编辑命令            | 支持修改名称、命令内容、类型（如本地命令转公仓命令）                  |
| 03       | 删除命令            | 支持批量选择（连续：`1-3`；离散：`1 3`；混合：`1-2 4`）              |
| 04       | 命令排序            | 完整排序（`5 2 3`）、局部调换（`1-3=3 1 2`）、两两对调（`1=7`）       |
| 05       | 同步管理            | GitHub模式：同步到GitHub/从GitHub同步；切换本地/GitHub模式            |
| 06       | 导入导出            | 导出：生成带毫秒时间戳的JSON文件（防覆盖）；导入：支持合并/替换        |
| 07       | 配置设置            | 查看当前配置、重新配置GitHub、导出快速连接、修改启动命令、查看帮助    |
| 00       | 返回一级界面        |                                                                      |
| 99       | 退出程序            |                                                                      |

### 3. GitHub模式配置（多设备同步）
#### 前置准备
1. **创建仓库**：在GitHub创建私有仓库（如 `cctb-commands`，推荐私有以保护命令隐私）
2. **生成Token**：  
   - 路径：GitHub账号 → Settings → Developer settings → Personal access tokens  
   - 权限：仅勾选 `repo`（最小权限原则，仅需contents权限）  
   - 保存Token：仅显示一次，后续需用Base58编码存储

#### 配置步骤
1. 启动工具：`cb`  
2. 输入 `99` 进入二级设置界面，选择 `07`（配置设置）→ `02`（重新配置GitHub）  
3. 按提示输入：  
   - GitHub仓库（格式：`用户名/仓库名`）  
   - GitHub Token（自动Base58编码存储，不明文保存）  
4. 测试连接成功后，自动提示是否同步远程命令


## 📁 文件结构
所有数据存储于 `~/.cctb/` 目录，删除该目录即重置工具：
```
~/.cctb/
├── config             # 核心配置（同步模式、GitHub仓库、缓存大小）
├── cmd_name           # 当前启动命令（默认cb，修改后生效）
├── commands.json      # 命令存储文件（JSON格式，可手动编辑）
├── version_local      # 本地安装版本号（用于版本对比）
├── version_latest     # 远程版本缓存（24小时内不重复拉取GitHub版本）
└── cctb_latest.sh     # 从GitHub拉取的最新脚本（用于更新）
```

### 关键文件示例
#### config 配置文件（GitHub模式）
```bash
SYNC_MODE=github
GITHUB_REPO=username/cctb-commands
GITHUB_TOKEN=Base58编码后的Token
CACHE_SIZE=15  # 自定义缓存大小为15条
```

#### commands.json 命令格式
```json
{
  "commands": [
    {
      "id": 1699999999999,
      "name": "系统监控",
      "command": "htop",
      "type": "本地",
      "description": "实时查看CPU/内存/进程状态",
      "created_at": "2024-10-15T14:30:00+08:00",
      "updated_at": "2024-10-15T14:30:00+08:00"
    },
    {
      "id": 1700000000000,
      "name": "公仓脚本示例",
      "command": "bash <(curl -s https://raw.githubusercontent.com/withabc/cctb/main/test.sh)",
      "type": "公仓",
      "description": "调用GitHub公共仓库脚本",
      "created_at": "2024-10-15T15:00:00+08:00",
      "updated_at": "2024-10-15T15:00:00+08:00"
    }
  ]
}
```


## ⚙️ 环境要求
### 依赖工具（自动检测并提示安装）
| 工具       | 用途                  | 安装命令（按系统选择）                          |
|------------|-----------------------|-----------------------------------------------|
| `jq`       | JSON解析（命令存储核心）| Ubuntu：`sudo apt install jq`；CentOS：`sudo yum install jq`；macOS：`brew install jq` |
| `curl`     | 网络请求（拉取脚本/同步）| Ubuntu：`sudo apt install curl`；Alpine：`sudo apk add curl` |
| `base64`   | 数据编解码（Token存储） | Linux自带；macOS需安装 `coreutils`（`brew install coreutils`） |


## 🔄 同步机制
| 同步场景                | 触发方式                                  | 行为说明                                                                 |
|-------------------------|-------------------------------------------|--------------------------------------------------------------------------|
| 自动同步（GitHub模式）  | 添加/编辑/删除命令、导入命令后            | 自动推送本地 `commands.json` 到GitHub仓库，Base64编码避免传输乱码         |
| 手动同步                | 执行 `cb -s` 或二级界面 `05`（同步管理）  | 支持“同步到GitHub”“从GitHub同步”，自动处理文件冲突（以远程为准）            |
| 版本缓存                | 远程版本信息缓存24小时，脚本缓存1小时      | 减少网络请求，加快启动速度                                               |
| 同步限制                | 单文件最大80MB（GitHub单文件限制）         | 超过时提示拆分命令或删除冗余内容                                         |


## 🐛 故障排除
| 常见问题                | 原因分析                                  | 解决方案                                                                  |
|-------------------------|-------------------------------------------|---------------------------------------------------------------------------|
| `jq: command not found` | 缺少JSON解析工具                          | 执行对应系统的安装命令（如Ubuntu：`sudo apt install jq`）                  |
| 同步失败（HTTP 404）    | GitHub仓库不存在/Token权限不足             | 1. 确认仓库路径正确；2. 检查Token是否勾选 `repo` 权限                     |
| 同步失败（文件过大）    | 命令文件超过80MB（GitHub限制）             | 拆分 `commands.json` 或删除不常用命令，重新同步                            |
| 启动命令修改后无效      | 新命令不在系统PATH中                      | 手动执行 `exec $新命令` 或重新打开终端，确保 `/usr/local/bin` 在PATH中     |
| Token解码失败           | Token格式错误或Base58编码异常             | 重新配置GitHub模式，输入正确的Token（格式：`ghp_`开头的40位字符串）        |


## 📝 版本信息
- 当前版本：v3.0.0
- 更新日志：
  1. 新增缓存机制，优化命令查询速度
  2. 拆分版本文件（`version_local` 本地版本、`version_latest` 远程缓存）
  3. 增强高危命令检测规则（补充通配符、权限篡改场景）
  4. 优化GitHub同步错误提示（明确HTTP状态码与原因）


## ⚠️ 注意事项
1. 请勿在公共GitHub仓库存储含敏感信息的命令（如密钥、密码）
2. 定期备份 `~/.cctb/commands.json`，避免配置丢失
3. GitHub Token仅需 `repo` 权限，无需授予其他敏感权限（最小权限原则）
4. 网络命令需确保目标URL可信，避免执行恶意脚本
