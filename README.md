# **CCTB** - 自定义命令工具箱

## 🌟 核心特性
| 特性                | 说明                                                                 |
|---------------------|----------------------------------------------------------------------|
| **快速执行**        | 输入数字直接运行命令，支持关键词模糊搜索（名称/内容/类型，不区分大小写）  |
| **三模式同步**      | 本地模式（纯本地存储）、GitHub模式（私有仓库同步）、WebDAV模式（私有服务器同步），敏感信息均通过Base58编码存储 |
| **智能缓存**        | 自动缓存最近N条命令（默认10条，可通过配置文件自定义缓存大小），重复执行优先加载缓存 |
| **高危命令防护**    | 检测 `rm -rf /`、`dd`、`shutdown`、`chmod 777 /` 等危险操作，强制二次确认并记录日志 |
| **跨平台兼容**      | 适配 Linux（Ubuntu/CentOS/Alpine）、macOS（含10.14以下旧版本），自动处理系统差异（如日期、stat命令） |
| **便捷管理**        | 支持命令添加/编辑/删除/排序，导入导出（JSON格式，导出防覆盖、导入支持合并去重/替换）  |
| **调试模式**        | 开启 `DEBUG=1 cb` 可查看缓存命中、同步日志、命令解析过程，便于问题排查            |

## 🚀 快速入门
### 1. 安装脚本
#### 推荐：一键安装（自动处理依赖与权限）
```bash
bash <(curl -fsSL https://raw.githubusercontent.com/withabc/cctb/main/cctb.sh)
```
#### 进阶：传参同步安装（新设备快速配置GitHub模式）
```bash
# 格式：一键安装 + 同步到指定GitHub仓库
bash <(curl -fsSL https://raw.githubusercontent.com/withabc/cctb/main/cctb.sh) --sync "用户名/仓库名" "YOUR_GITHUB_TOKEN"
```
#### 手动安装（适合离线环境）
```bash
# 1. 下载脚本
wget https://raw.githubusercontent.com/withabc/cctb/main/cctb.sh -O cctb.sh
# 2. 添加执行权限
chmod +x cctb.sh
# 3. 安装到系统路径（需sudo权限）
sudo cp cctb.sh /usr/local/bin/cb
sudo chmod +x /usr/local/bin/cb
```
### 2. 基础用法
#### 启动工具（默认命令：`cb`，可自定义）
```bash
cb
```
#### 命令行选项
```bash
cb [选项]
选项说明：
  cb                    启动一级主界面（仅显示可执行命令，屏蔽管理操作）
  cb -h/--help          查看完整帮助文档
  cb -v/--version       查看当前版本及核心特性
  cb -m/--manage        直接进入二级设置界面（命令管理/同步/配置）
  cb -s/--sync          手动触发同步（GitHub/WebDAV模式有效，自动处理冲突）
  cb -l/--list          列出所有已存储命令（显示编号、类型、名称）
  cb --reset            重置配置（清除 ~/.cctb 下所有数据，重新选择模式）
  cb --change-cmd       修改启动命令（如从cb改为cctb，自动重启生效）
  DEBUG=1 cb            开启调试模式（显示缓存日志、同步过程、命令解析）
```

## 🔧 功能详解
### 1. 命令类型（4种类型适配不同场景）
| 类型                | 适用场景                                  | 配置示例                                  |
|---------------------|-------------------------------------------|-------------------------------------------|
| **本地命令**        | 单机常用命令（如系统监控、进程查看）      | 命令内容：`htop`、`docker ps -a`          |
| **私仓命令**        | GitHub模式专属，使用已配置仓库/分支       | 自动加载仓库（默认main分支），仅需输入脚本名（如 `cctb.sh`） |
| **公仓命令**        | 调用GitHub公共仓库脚本                    | 路径格式：`user/repo/branch/script.sh`（如 `withabc/cctb/main/test.sh`） |
| **网络命令**        | 调用远程网络脚本                          | 网址格式：`test.com/test.sh`（自动补全http/https前缀） |

### 2. 同步模式（3种模式适配不同场景）
| 模式                | 适用场景                                  | 核心配置要求                                  |
|---------------------|-------------------------------------------|-------------------------------------------|
| **本地模式**        | 单设备使用，无需多端同步                  | 无需额外配置，命令存储于 `~/.cctb/commands.json` |
| **GitHub模式**      | 多设备跨网络同步，依赖GitHub仓库          | 1. GitHub仓库（格式：`用户名/仓库名`）；2. 含contents权限的Token（Base58编码存储） |
| **WebDAV模式**      | 多设备局域网/私有服务器同步                | 1. WebDAV地址（需http/https开头）；2. 账号密码（Base58编码存储，需写入权限） |

### 3. 界面操作规则
#### 一级主界面（执行命令）
- 输入 **命令编号**：直接执行对应命令
- 输入 **关键词**：模糊搜索命令（如输入 `docker` 匹配所有含docker的命令）
- 输入 **99**：进入二级设置界面
- 输入 **00**：退出程序
- 屏蔽操作：禁止直接输入01-07（需进入二级界面操作）

#### 二级设置界面（命令管理）
| 操作编号 | 功能                | 说明                                                                 |
|----------|---------------------|----------------------------------------------------------------------|
| 01       | 添加命令            | 选择4种命令类型，自动校验高危命令，同步模式下添加后自动同步到云端            |
| 02       | 编辑命令            | 支持修改名称、命令内容、类型（如本地命令转公仓命令），同步模式下自动同步      |
| 03       | 删除命令            | 支持批量选择（连续：`1-3`；离散：`1 3`；混合：`1-2 4`），同步模式下自动同步 |
| 04       | 命令排序            | 支持完整排序（`5 2 3`）、局部调换（`1-3=3 1 2`）、两两对调（`1=7`）         |
| 05       | 同步管理            | 切换同步模式（本地/GitHub/WebDAV）、执行手动同步、导出GitHub快速连接        |
| 06       | 文件导出            | 导出：生成带毫秒时间戳的JSON文件（防覆盖）；导入：支持合并去重/替换模式      |
| 07       | 配置设置            | 查看当前配置、删除同步配置、修改启动命令、查看帮助信息                      |
| 00       | 返回一级界面        |                                                                      |
| 99       | 退出程序            |                                                                      |

### 4. 关键功能细节
#### 高危命令防护
- **检测范围**：涵盖根目录删除（`sudo rm -rf /`）、磁盘写入（`sudo dd`）、系统关机（`sudo shutdown`）、全局权限篡改（`sudo chmod 777 /`）等16类高危操作
- **防护机制**：添加/执行时强制二次确认，添加高危命令自动记录日志（路径：`~/.cctb/high_risk_cmd.log`），包含操作时间、用户、命令详情

#### 智能缓存
- **缓存规则**：默认缓存10条最近执行命令，缓存大小可通过配置文件（`CACHE_SIZE`）自定义
- **自动清空场景**：命令添加/编辑/删除/排序、导入导出、云端同步、切换同步模式后，自动清空缓存确保数据最新
- **调试查看**：开启DEBUG模式可查看缓存命中（如「缓存命中：htop（键：htop_1）」）与更新日志

#### 导入导出
- **导出特性**：自动生成含毫秒时间戳的文件名（如 `cctb_commands_20240520_153045_1234567.json`），避免覆盖现有文件
- **导入模式**：
  - 合并模式：保留现有命令，自动跳过同名命令（大小写不敏感去重）
  - 替换模式：覆盖现有所有命令，适用于批量迁移场景
- **格式要求**：导入文件需为标准JSON，根节点含`commands`数组，每个命令需有`name`（名称）和`command`（内容）字段

## 📁 文件结构
所有数据存储于 `~/.cctb/` 目录，删除该目录即完全重置工具：
```
~/.cctb/
├── config             # 核心配置（同步模式、GitHub/WebDAV配置、缓存大小）
├── cmd_name           # 当前启动命令（默认cb，修改后立即生效）
├── commands.json      # 命令存储文件（JSON格式，格式错误自动重置为空数组）
├── version_local      # 本地安装版本号（用于版本对比）
├── version_latest     # 远程版本缓存（24小时内不重复拉取，减少网络请求）
├── cctb_latest        # 从GitHub拉取的最新脚本（用于更新或安装）
├── cache              # 命令缓存文件（存储最近执行的命令，加速加载）
├── high_risk_cmd.log  # 高危命令操作日志（记录高危命令添加记录）
└── temp.json          # 临时文件（命令编辑/排序时使用，避免原文件损坏）
```

### 关键文件示例
#### config 配置文件（WebDAV模式）
```bash
SYNC_MODE=WebDAV
GITHUB_REPO=username/cctb-commands（保留GitHub配置）
GITHUB_TOKEN=Base58编码后的Token（保留GitHub配置）
WEBDAV_URL=https://dav.example.com
WEBDAV_USER=webdav_user
WEBDAV_PASS=Base58编码后的密码
CACHE_SIZE=15  # 自定义缓存大小为15条
```

#### commands.json 命令格式
```json
{
  "commands": [
    {
      "id": 1699999999999,
      "name": "系统监控",
      "command": "htop",
      "type": "本地",
      "description": "实时查看CPU/内存/进程状态",
      "created_at": "2024-10-15T14:30:00+08:00",
      "updated_at": "2024-10-15T14:30:00+08:00"
    },
    {
      "id": 1700000000000,
      "name": "WebDAV同步测试",
      "command": "bash <(curl -s https://dav.example.com/test.sh)",
      "type": "网络",
      "description": "调用WebDAV服务器上的测试脚本",
      "created_at": "2024-10-15T15:00:00+08:00",
      "updated_at": "2024-10-15T15:00:00+08:00"
    }
  ]
}
```

## ⚙️ 环境要求
### 依赖工具（自动检测并提示安装）
| 工具       | 用途                  | 安装命令（按系统选择）                          |
|------------|-----------------------|-----------------------------------------------|
| `jq`       | JSON解析（命令存储核心）| Ubuntu：`sudo apt install jq`；CentOS：`sudo yum install jq`；macOS：`brew install jq` |
| `curl`     | 网络请求（拉取脚本/同步）| Ubuntu：`sudo apt install curl`；Alpine：`sudo apk add curl` |
| `base64`   | 数据编解码（命令内容处理） | Linux自带；macOS需安装 `coreutils`（`brew install coreutils`） |
| `stat`     | 文件属性获取（版本缓存/文件大小检测） | Linux自带；macOS自带（自动适配新旧版本参数） |

## 🔄 同步机制
| 同步场景                | 触发方式                                  | 行为说明                                                                 |
|-------------------------|-------------------------------------------|--------------------------------------------------------------------------|
| 自动同步（GitHub/WebDAV）| 添加/编辑/删除命令、导入命令后            | 自动推送本地 `commands.json` 到云端，Base64编码避免传输乱码               |
| 手动同步                | 执行 `cb -s` 或二级界面 `05`（同步管理）  | GitHub模式支持“同步到GitHub/从GitHub同步”，WebDAV模式支持“同步到WebDAV/从WebDAV同步” |
| 版本缓存                | 远程版本信息缓存24小时，最新脚本缓存1小时 | 减少网络请求，加快启动速度                                               |
| 同步限制                | GitHub单文件最大80MB，WebDAV建议≤100MB    | 超过时提示拆分命令或删除冗余内容                                         |

## 🐛 故障排除
| 常见问题                | 原因分析                                  | 解决方案                                                                  |
|-------------------------|-------------------------------------------|---------------------------------------------------------------------------|
| `jq: command not found` | 缺少JSON解析工具                          | 执行对应系统的安装命令（如Ubuntu：`sudo apt install jq`）                  |
| GitHub同步失败（404）   | 仓库不存在/Token权限不足                  | 1. 确认仓库路径正确；2. 检查Token是否勾选 `repo` 权限                     |
| WebDAV同步失败（401）   | 账号密码错误                              | 进入“07. 配置设置”重新配置WebDAV账号密码，确保Base58解码正常               |
| WebDAV同步失败（405）   | 服务器禁用MKCOL（目录创建）方法           | 手动用FileZilla/Rclone创建 `cctb` 目录（路径：WebDAV地址/cctb/）后重试     |
| 启动命令修改后无效      | 新命令不在系统PATH中                      | 执行 `exec $SHELL` 或重新打开终端，确保 `/usr/local/bin` 在PATH中          |
| 命令文件格式错误        | 手动编辑 `commands.json` 时格式异常       | 工具自动重置为 `{"commands": []}`，需重新导入命令或添加命令（建议编辑前备份） |

## 📝 版本信息
- 当前版本：v3.5.0
- 更新日志：
  1. 新增WebDAV同步模式，支持私有服务器多设备同步
  2. 优化Base58编解码逻辑，修复特殊字符解码异常问题
  3. 增强WebDAV连接容错，支持自动创建目录、多场景错误提示
  4. 完善跨平台兼容，适配macOS 10.14以下旧版本stat/date命令
  5. 新增命令列表查看选项（`cb -l/--list`），快速查看所有命令
  6. 优化缓存机制，支持缓存文件重建、缓存命中日志详细输出

## ⚠️ 注意事项
1. 请勿在公共仓库/服务器存储含敏感信息的命令（如密钥、密码）
2. 定期备份 `~/.cctb/commands.json`，避免配置丢失
3. GitHub Token仅需 `repo` 权限，WebDAV账号仅需目录创建/文件写入权限，遵循最小权限原则
4. 网络命令需确保目标URL可信，避免执行恶意脚本
5. 修改启动命令后若无效，需手动刷新Shell环境（`exec $SHELL`）或重新打开终端
